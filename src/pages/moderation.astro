---
import Layout from '../layouts/Layout.astro';
---

<Layout
  title="Moderation"
  description="Approve or reject pending submissions with Supabase-authenticated moderator access."
>
  <section class="page-hero">
    <p><strong>Moderation</strong></p>
    <h1>Approve or reject pending submissions.</h1>
    <p>
      Sign in with your moderator email, then review pending entries. Your email must be listed in
      `MODERATOR_EMAILS`.
    </p>
  </section>

  <section class="panel stack">
    <div id="mod-auth-status" role="status" aria-live="polite"></div>

    <form id="login-form" class="auth-form">
      <label>
        Moderator email
        <input id="moderator-email" type="email" required />
      </label>
      <button class="btn btn-primary" type="submit">Send magic link</button>
    </form>

    <div id="session-actions" class="cta-row hidden">
      <button id="refresh-pending" class="btn btn-secondary" type="button">Refresh queue</button>
      <button id="sign-out" class="btn btn-secondary" type="button">Sign out</button>
    </div>
  </section>

  <section class="panel">
    <h2>Pending queue</h2>
    <p id="pending-summary">Sign in to load pending submissions.</p>
    <div id="pending-list" class="pending-list"></div>
  </section>
</Layout>

<script>
  import { createClient } from '@supabase/supabase-js';

  const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
  const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;

  const authStatus = document.querySelector('#mod-auth-status');
  const pendingSummary = document.querySelector('#pending-summary');
  const pendingList = document.querySelector('#pending-list');
  const loginForm = document.querySelector('#login-form');
  const emailInput = document.querySelector('#moderator-email');
  const sessionActions = document.querySelector('#session-actions');
  const refreshPendingButton = document.querySelector('#refresh-pending');
  const signOutButton = document.querySelector('#sign-out');

  if (
    !(authStatus instanceof HTMLElement) ||
    !(pendingSummary instanceof HTMLElement) ||
    !(pendingList instanceof HTMLElement) ||
    !(loginForm instanceof HTMLFormElement) ||
    !(emailInput instanceof HTMLInputElement) ||
    !(sessionActions instanceof HTMLElement) ||
    !(refreshPendingButton instanceof HTMLButtonElement) ||
    !(signOutButton instanceof HTMLButtonElement)
  ) {
    throw new Error('Moderation UI failed to initialize.');
  }

  if (!supabaseUrl || !supabaseAnonKey) {
    authStatus.textContent =
      'Missing Supabase public config. Set PUBLIC_SUPABASE_URL and PUBLIC_SUPABASE_ANON_KEY.';
    loginForm.classList.add('hidden');
  } else {
    const supabase = createClient(supabaseUrl, supabaseAnonKey);
    let activeToken = '';
    let activeEmail = '';

    const setSignedOutState = () => {
      activeToken = '';
      activeEmail = '';
      loginForm.classList.remove('hidden');
      sessionActions.classList.add('hidden');
      pendingSummary.textContent = 'Sign in to load pending submissions.';
      pendingList.innerHTML = '';
      authStatus.textContent = '';
    };

    const loadPending = async () => {
      if (!activeToken) {
        return;
      }

      pendingSummary.textContent = 'Loading pending submissions...';

      const response = await fetch('/api/moderate', {
        headers: {
          Authorization: `Bearer ${activeToken}`,
        },
      });
      const body = await response.json();

      if (!response.ok || !body.ok) {
        pendingSummary.textContent = body.message ?? 'Failed to load pending queue.';
        return;
      }

      const pending = body.pending ?? [];
      pendingSummary.textContent = pending.length
        ? `${pending.length} pending submissions`
        : 'No pending submissions right now.';
      pendingList.innerHTML = '';

      for (const entry of pending) {
        const card = document.createElement('article');
        card.className = 'pending-card';
        card.innerHTML = `
          <h3>${entry.roleTitle}</h3>
          <p>${entry.industry} · ${entry.location} · ${entry.workMode} · ${entry.yearsExperience}y exp</p>
          <p><strong>Submitted:</strong> ${new Date(entry.createdAt).toLocaleString()}</p>
          <p><strong>Review notes:</strong> ${entry.reviewNotes ?? 'None'}</p>
          <label>
            Optional review note
            <textarea rows="3" placeholder="Reason for rejection or approval context"></textarea>
          </label>
          <div class="cta-row">
            <button class="btn btn-primary" data-action="approved" data-id="${entry.id}">Approve</button>
            <button class="btn btn-secondary" data-action="rejected" data-id="${entry.id}">Reject</button>
          </div>
        `;
        pendingList.appendChild(card);
      }
    };

    const refreshAuthState = async () => {
      const { data, error } = await supabase.auth.getSession();
      const session = data.session;

      if (error || !session) {
        setSignedOutState();
        return;
      }

      activeToken = session.access_token;
      activeEmail = session.user.email ?? '';
      authStatus.textContent = `Signed in as ${activeEmail}`;
      loginForm.classList.add('hidden');
      sessionActions.classList.remove('hidden');
      await loadPending();
    };

    loginForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const email = emailInput.value.trim();
      if (!email) {
        authStatus.textContent = 'Enter your moderator email first.';
        return;
      }

      authStatus.textContent = 'Sending magic link...';
      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: {
          emailRedirectTo: `${window.location.origin}/moderation`,
        },
      });

      authStatus.textContent = error
        ? error.message
        : 'Magic link sent. Open your email and return to this page.';
    });

    refreshPendingButton.addEventListener('click', async () => {
      await loadPending();
    });

    signOutButton.addEventListener('click', async () => {
      await supabase.auth.signOut();
      setSignedOutState();
    });

    pendingList.addEventListener('click', async (event) => {
      const target = event.target;
      if (!(target instanceof HTMLButtonElement)) {
        return;
      }

      const action = target.dataset.action;
      const submissionId = target.dataset.id;
      if (!submissionId || (action !== 'approved' && action !== 'rejected')) {
        return;
      }

      const card = target.closest('.pending-card');
      const noteInput = card?.querySelector('textarea');
      const reviewNotes = noteInput instanceof HTMLTextAreaElement ? noteInput.value.trim() : '';

      target.disabled = true;
      const response = await fetch('/api/moderate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${activeToken}`,
        },
        body: JSON.stringify({
          id: submissionId,
          status: action,
          reviewNotes: reviewNotes || undefined,
        }),
      });

      const body = await response.json();
      if (!response.ok || !body.ok) {
        authStatus.textContent = body.message ?? 'Failed to update moderation status.';
        target.disabled = false;
        return;
      }

      authStatus.textContent = `Submission ${submissionId} marked as ${action}.`;
      await loadPending();
    });

    supabase.auth.onAuthStateChange(() => {
      void refreshAuthState();
    });

    void refreshAuthState();
  }
</script>

<style>
  .hidden {
    display: none;
  }

  .auth-form {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    align-items: end;
  }

  .auth-form label {
    display: grid;
    gap: 0.35rem;
    color: var(--ink-soft);
    font-weight: 700;
    min-width: min(400px, 100%);
  }

  .auth-form input,
  .pending-card textarea {
    font: inherit;
    border: 1px solid var(--line);
    background: #fff;
    border-radius: 10px;
    padding: 0.48rem 0.55rem;
  }

  .pending-list {
    display: grid;
    gap: 0.8rem;
  }

  .pending-card {
    border: 1px solid var(--line);
    border-radius: 14px;
    padding: 0.9rem;
    background: #fff;
    display: grid;
    gap: 0.55rem;
  }

  .pending-card h3,
  .pending-card p {
    margin: 0;
  }

  .pending-card p {
    color: var(--ink-soft);
  }

  .pending-card label {
    display: grid;
    gap: 0.35rem;
    color: var(--ink-soft);
    font-weight: 700;
  }
</style>
