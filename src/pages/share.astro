---
import Layout from '../layouts/Layout.astro';
import { INDUSTRIES, SENIORITY_LEVELS, SUBMITTER_TYPES, WORK_MODES } from '../lib/job-schema';
---

<Layout title="Share Your Job Story" description="Submit a structured career story for moderation.">
  <section class="page-hero">
    <p><strong>Share Your Story</strong></p>
    <h1>Help students understand what this work is really like.</h1>
    <p>
      No login required. Every submission is validated and queued for manual moderation before it
      appears in the public directory.
    </p>
  </section>

  <form class="panel share-form" id="share-form">
    <label class="honeypot-field" aria-hidden="true" tabindex="-1">
      Website
      <input name="website" type="text" autocomplete="off" tabindex="-1" />
    </label>

    <section class="form-block" aria-label="Role basics">
      <h2>About the role</h2>
      <p class="block-note">These details help readers find relevant stories.</p>
      <div class="form-grid">
        <label>
          Role title *
          <input name="roleTitle" required />
        </label>

        <label>
          Industry *
          <select name="industry" required>
            <option value="">Select one</option>
            {INDUSTRIES.map((industry) => <option value={industry}>{industry}</option>)}
          </select>
        </label>

        <label>
          Seniority *
          <select name="seniority" required>
            <option value="">Select one</option>
            {SENIORITY_LEVELS.map((level) => <option value={level}>{level}</option>)}
          </select>
        </label>

        <label>
          Location *
          <input name="location" placeholder="City, country or Remote" required />
        </label>

        <label>
          Work mode *
          <select name="workMode" required>
            <option value="">Select one</option>
            {WORK_MODES.map((mode) => <option value={mode}>{mode}</option>)}
          </select>
        </label>

        <label>
          Years of experience *
          <input type="number" min="0" max="50" name="yearsExperience" required />
        </label>
      </div>
    </section>

    <details class="form-block optional-block">
      <summary>Additional details (optional)</summary>
      <div class="form-grid">
        <label>
          Salary range
          <input name="salaryRange" placeholder="$60k-$75k" />
        </label>

        <label>
          Education path
          <input name="educationPath" />
        </label>
      </div>
    </details>

    <section class="form-block" aria-label="Work reality">
      <h2>What the work is really like</h2>
      <div class="form-grid">
        <label class="span-all">
          Tools used (comma-separated) *
          <input name="toolsUsed" placeholder="Excel, SQL, Figma" required />
        </label>

        <label class="span-all">
          What do you do day-to-day? *
          <textarea name="dayToDay" rows="4" required></textarea>
        </label>

        <label class="span-all">
          Best parts *
          <textarea name="bestParts" rows="3" required></textarea>
        </label>

        <label class="span-all">
          Hardest parts *
          <textarea name="hardestParts" rows="3" required></textarea>
        </label>
      </div>
    </section>

    <section class="form-block" aria-label="Student advice">
      <h2>Advice to students</h2>
      <div class="form-grid">
        <label class="span-all">
          Recommendation to students *
          <textarea name="recommendationToStudents" rows="3" required></textarea>
        </label>
      </div>
    </section>

    <section class="form-block" aria-label="Submitter identity">
      <h2>Submitter info</h2>
      <div class="form-grid">
        <label>
          Submitter type *
          <select name="submitterType" required>
            {SUBMITTER_TYPES.map((type) => <option value={type}>{type}</option>)}
          </select>
        </label>

        <label>
          Contact email (optional)
          <input name="contactEmail" type="email" placeholder="name@email.com" />
        </label>
      </div>
    </section>

    <div id="share-error-summary" class="error-summary hidden" role="alert" aria-live="assertive">
    </div>

    <div class="submit-bar">
      <button class="btn btn-primary" type="submit">Submit for moderation</button>
      <p id="share-status" role="status" aria-live="polite"></p>
    </div>
  </form>
</Layout>

<script>
  const form = document.querySelector('#share-form');
  const status = document.querySelector('#share-status');
  const errorSummary = document.querySelector('#share-error-summary');

  if (
    form instanceof HTMLFormElement &&
    status instanceof HTMLParagraphElement &&
    errorSummary instanceof HTMLDivElement
  ) {
    const sendEvent = (event: 'page_share_success', metadata?: Record<string, unknown>) => {
      const payload = {
        event,
        path: window.location.pathname,
        sessionId: window.sessionStorage.getItem('realjobscope_session_id') ?? undefined,
        metadata,
      };

      if (navigator.sendBeacon) {
        const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
        navigator.sendBeacon('/api/events', blob);
        return;
      }

      void fetch('/api/events', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        keepalive: true,
      });
    };

    const fieldLabels: Record<string, string> = {
      roleTitle: 'Role title',
      industry: 'Industry',
      seniority: 'Seniority',
      location: 'Location',
      workMode: 'Work mode',
      yearsExperience: 'Years of experience',
      salaryRange: 'Salary range',
      educationPath: 'Education path',
      toolsUsed: 'Tools used',
      dayToDay: 'Day-to-day',
      bestParts: 'Best parts',
      hardestParts: 'Hardest parts',
      recommendationToStudents: 'Recommendation to students',
      submitterType: 'Submitter type',
      contactEmail: 'Contact email',
      website: 'Website',
    };

    const clearFieldErrors = () => {
      const controls = form.querySelectorAll('input, select, textarea');
      for (const control of controls) {
        if (
          control instanceof HTMLInputElement ||
          control instanceof HTMLSelectElement ||
          control instanceof HTMLTextAreaElement
        ) {
          control.classList.remove('field-error');
          control.removeAttribute('aria-invalid');
        }
      }

      const messages = form.querySelectorAll('.field-message');
      for (const message of messages) {
        message.remove();
      }

      errorSummary.classList.add('hidden');
      errorSummary.innerHTML = '';
    };

    const applyFieldErrors = (errors: unknown) => {
      if (!errors || typeof errors !== 'object') {
        return;
      }

      let firstInvalidControl = null;
      const summaryItems: Array<{ label: string; message: string }> = [];

      for (const [name, messages] of Object.entries(errors)) {
        const control = form.querySelector(`[name="${name}"]`);
        if (
          !(
            control instanceof HTMLInputElement ||
            control instanceof HTMLSelectElement ||
            control instanceof HTMLTextAreaElement
          )
        ) {
          continue;
        }

        control.classList.add('field-error');
        control.setAttribute('aria-invalid', 'true');
        const details = control.closest('details');
        if (details instanceof HTMLDetailsElement) {
          details.open = true;
        }
        if (!firstInvalidControl) {
          firstInvalidControl = control;
        }

        if (Array.isArray(messages) && messages.length > 0) {
          const message = String(messages[0] ?? '');
          const helper = document.createElement('p');
          helper.className = 'field-message';
          helper.textContent = message;
          control.insertAdjacentElement('afterend', helper);
          const label = fieldLabels[name] ?? name;
          summaryItems.push({ label, message });
        }
      }

      if (summaryItems.length > 0) {
        errorSummary.classList.remove('hidden');
        errorSummary.replaceChildren();

        const heading = document.createElement('h3');
        heading.textContent = 'Please correct the following fields:';
        errorSummary.appendChild(heading);

        const list = document.createElement('ul');
        for (const item of summaryItems) {
          const li = document.createElement('li');
          const strong = document.createElement('strong');
          strong.textContent = `${item.label}:`;
          li.appendChild(strong);
          li.appendChild(document.createTextNode(` ${item.message}`));
          list.appendChild(li);
        }
        errorSummary.appendChild(list);
      }

      if (firstInvalidControl) {
        firstInvalidControl.focus();
      }
    };

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      clearFieldErrors();
      status.classList.remove('status-error');
      status.textContent = 'Submitting...';

      const formData = new FormData(form);
      const payload = Object.fromEntries(formData.entries());
      const submissionPayload = {
        ...payload,
        yearsExperience: Number(payload.yearsExperience),
      };

      try {
        const response = await fetch('/api/share', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(submissionPayload),
        });

        const data = await response.json();
        if (response.ok) {
          form.reset();
          status.textContent = data.message;
          sendEvent('page_share_success', {
            storage: data.storage ?? 'unknown',
          });
          return;
        }

        status.classList.add('status-error');
        if (data.errors) {
          applyFieldErrors(data.errors);
        } else if (data.message) {
          errorSummary.classList.remove('hidden');
          errorSummary.replaceChildren();
          const message = document.createElement('p');
          message.textContent = String(data.message);
          errorSummary.appendChild(message);
        }
        status.textContent = data.message ?? 'Submission failed. Please review and try again.';
      } catch {
        status.classList.add('status-error');
        errorSummary.classList.remove('hidden');
        errorSummary.innerHTML = '<p>Network error while submitting. Please try again.</p>';
        status.textContent = 'Network error while submitting. Please try again.';
      }
    });
  }
</script>

<style>
  .share-form {
    display: grid;
    gap: 1rem;
    padding: 1.2rem;
    border-radius: 22px;
  }

  .form-block {
    margin: 0;
    padding: 0;
    border: 0;
    display: grid;
    gap: 0.65rem;
  }

  .form-block + .form-block {
    padding-top: 0.9rem;
    border-top: 1px solid rgba(15, 42, 59, 0.1);
  }

  .form-block h2 {
    margin: 0;
    font-size: 1.12rem;
    line-height: 1.2;
  }

  .block-note {
    margin: 0;
    color: var(--ink-soft);
    font-size: 0.95rem;
  }

  .form-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 0.85rem;
  }

  .form-grid label {
    display: grid;
    gap: 0.35rem;
    font-weight: 700;
    color: var(--ink-soft);
    min-width: 0;
  }

  .honeypot-field {
    position: absolute;
    left: -9999px;
    width: 1px;
    height: 1px;
    overflow: hidden;
  }

  .form-grid input,
  .form-grid select,
  .form-grid textarea {
    font: inherit;
    border: 1px solid var(--line);
    background: rgba(255, 255, 255, 0.92);
    border-radius: 10px;
    padding: 0.56rem 0.6rem;
    width: 100%;
    min-width: 0;
  }

  .form-grid textarea {
    resize: vertical;
    min-height: 7.2rem;
  }

  .share-form .field-error {
    border-color: #c22d1d;
    box-shadow: 0 0 0 1px rgba(194, 45, 29, 0.2);
  }

  .field-message {
    margin: 0;
    color: #9b2014;
    font-size: 0.82rem;
    font-weight: 600;
  }

  .span-all {
    grid-column: 1 / -1;
  }

  .optional-block {
    border: 1px solid rgba(15, 42, 59, 0.12);
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.52);
    padding: 0.7rem;
  }

  .optional-block summary {
    cursor: pointer;
    font-weight: 700;
    color: var(--ink-strong);
  }

  .optional-block[open] summary {
    margin-bottom: 0.7rem;
  }

  .error-summary {
    border: 1px solid #d77961;
    background: linear-gradient(180deg, #fff4f0, #ffe9e2);
    border-radius: 12px;
    padding: 0.8rem 0.9rem;
    color: #7f1d12;
  }

  .error-summary.hidden {
    display: none;
  }

  .error-summary h3 {
    margin: 0 0 0.4rem;
    font-size: 0.95rem;
  }

  .error-summary p,
  .error-summary ul {
    margin: 0;
    padding-left: 1rem;
  }

  .error-summary li {
    margin: 0.15rem 0;
  }

  .submit-bar {
    display: grid;
    gap: 0.55rem;
    align-items: center;
  }

  .submit-bar .btn {
    width: fit-content;
  }

  #share-status {
    margin: 0;
    color: var(--ink-soft);
  }

  #share-status.status-error {
    color: #9b2014;
  }

  @media (max-width: 760px) {
    .share-form {
      padding: 1rem;
      gap: 0.9rem;
    }

    .form-grid {
      grid-template-columns: 1fr;
    }

    .submit-bar {
      position: sticky;
      bottom: 0.5rem;
      background: color-mix(in srgb, var(--bg-base) 92%, transparent);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 0.55rem;
      z-index: 20;
    }

    .submit-bar .btn {
      width: 100%;
    }
  }
</style>
