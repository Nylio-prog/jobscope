---
import JobCard from './JobCard.astro';
import { applyJobFilters, getDirectoryFacets, parseDirectoryFilters, sortJobs } from '../lib/jobs';
import { listApprovedJobProfiles } from '../lib/job-profiles-repository';

type Props = {
  search: string;
};

const { search } = Astro.props;

const filters = parseDirectoryFilters(new URLSearchParams(search.replace(/^\?/, '')));
const allJobs = await listApprovedJobProfiles();
const filteredJobs = sortJobs(applyJobFilters(allJobs, filters), filters.sort);
const facets = getDirectoryFacets(allJobs);
---

<form class="panel filters" method="get">
  <label>
    Keyword
    <input
      type="search"
      name="q"
      value={filters.query ?? ''}
      placeholder="nurse, product, policy..."
    />
  </label>

  <label>
    Industry
    <select name="industry">
      <option value="">All industries</option>
      {
        facets.industries.map((industry) => (
          <option value={industry} selected={filters.industry === industry}>
            {industry}
          </option>
        ))
      }
    </select>
  </label>

  <label>
    Work mode
    <select name="workMode">
      <option value="">All modes</option>
      {
        facets.workModes.map((workMode) => (
          <option value={workMode} selected={filters.workMode === workMode}>
            {workMode}
          </option>
        ))
      }
    </select>
  </label>

  <label>
    Sort
    <select name="sort">
      <option value="newest" selected={filters.sort === 'newest'}>Newest first</option>
      <option value="title-asc" selected={filters.sort === 'title-asc'}>Title A-Z</option>
      <option value="experience-asc" selected={filters.sort === 'experience-asc'}>
        Experience low-high
      </option>
      <option value="experience-desc" selected={filters.sort === 'experience-desc'}>
        Experience high-low
      </option>
    </select>
  </label>

  <div class="cta-row">
    <button class="btn btn-primary" type="submit">Apply filters</button>
    <a class="btn btn-secondary" href="/jobs">Reset</a>
  </div>
</form>

<div class="results-head">
  <p class="result-count">{filteredJobs.length} jobs found</p>
  <p class="result-tip">Open any story to see practical details, tools, and student advice.</p>
</div>
<section class="job-grid">
  {filteredJobs.map((job) => <JobCard job={job} />)}
</section>

<style>
  .filters {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
    gap: 0.9rem;
  }

  .filters label {
    display: grid;
    gap: 0.3rem;
    font-weight: 700;
    color: var(--ink-soft);
    min-width: 0;
  }

  .filters input,
  .filters select,
  .filters button {
    font: inherit;
  }

  .filters input,
  .filters select {
    border: 1px solid var(--line);
    background: #fff;
    border-radius: 10px;
    padding: 0.48rem 0.55rem;
    width: 100%;
    min-width: 0;
  }

  .result-count {
    margin: 0;
    color: var(--ink-soft);
    font-weight: 700;
  }

  .results-head {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    gap: 0.5rem;
  }

  .result-tip {
    margin: 0;
    color: var(--ink-soft);
    font-size: 0.92rem;
  }

  .job-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 0.9rem;
  }

  @media (max-width: 720px) {
    .job-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
